---
title: Password Reset - Flujo de Recuperaci√≥n Seguro
description: Domina el flujo de recuperaci√≥n de contrase√±a, generaci√≥n de tokens, limitaci√≥n de tasa, plantillas de email, verificaci√≥n de seguridad y patrones de protecci√≥n contra abuso listos para producci√≥n.
---

# Advertencia

:::u-alert
---
title: Los comentarios en el c√≥digo son solo para fines educativos.
description: En proyectos reales, evita agregar comentarios irrelevantes o redundantes.
color: warning
variant: subtle
icon: i-lucide-triangle-alert
---
:::

Los usuarios olvidan sus contrase√±as. Es inevitable. Un flujo de recuperaci√≥n de contrase√±a seguro es crucial para la experiencia del usuario y la seguridad de tu aplicaci√≥n. Debe ser f√°cil de usar pero robusto contra ataques.

---

## Flujo de Recuperaci√≥n de Contrase√±a

### Descripci√≥n General del Flujo

```
1. Usuario solicita reset
   ‚Üì
2. Verificar email existe
   ‚Üì
3. Generar token seguro
   ‚Üì
4. Enviar email con link
   ‚Üì
5. Usuario hace clic en link
   ‚Üì
6. Verificar token v√°lido
   ‚Üì
7. Mostrar formulario de reset
   ‚Üì
8. Validar nueva contrase√±a
   ‚Üì
9. Actualizar contrase√±a
   ‚Üì
10. Invalidar todos los tokens
```

### Requisitos de Seguridad

- ‚úÖ **Tokens √∫nicos y temporales** (15-30 minutos)
- ‚úÖ **Rate limiting** para prevenir ataques de fuerza bruta
- ‚úÖ **Verificaci√≥n de token** en servidor
- ‚úÖ **Invalidaci√≥n de tokens** despu√©s del uso
- ‚úÖ **Notificaciones** de cambios de contrase√±a
- ‚úÖ **Logging** de intentos de reset

---

## Solicitud de Reset de Contrase√±a

### Formulario de Solicitud

```tsx
// src/pages/PasswordResetRequestPage.tsx

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Link, useNavigate } from 'react-router-dom'
import { apiClient } from '@/lib/api-client'

const resetRequestSchema = z.object({
  email: z.string().email('Ingresa un email v√°lido'),
})

type ResetRequestData = z.infer<typeof resetRequestSchema>

export function PasswordResetRequestPage() {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [success, setSuccess] = useState(false)
  const navigate = useNavigate()
  
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ResetRequestData>({
    resolver: zodResolver(resetRequestSchema),
  })

  const onSubmit = async (data: ResetRequestData) => {
    setIsSubmitting(true)
    
    try {
      await apiClient.post('/auth/password-reset/request', data)
      setSuccess(true)
      
      // Redirigir a p√°gina de confirmaci√≥n despu√©s de 3 segundos
      setTimeout(() => {
        navigate('/password-reset/sent')
      }, 3000)
    } catch (error) {
      console.error('Error al solicitar reset:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (success) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-950">
        <div className="max-w-md w-full p-8 bg-slate-900 rounded-xl">
          <div className="text-center">
            <div className="w-16 h-16 bg-green-600 bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-slate-100 mb-2">
              Email Enviado
            </h2>
            <p className="text-slate-400 mb-6">
              Hemos enviado instrucciones para resetear tu contrase√±a a tu email.
            </p>
            <p className="text-sm text-slate-500">
              Ser√°s redirigido autom√°ticamente...
            </p>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950">
      <div className="max-w-md w-full p-8 bg-slate-900 rounded-xl">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-slate-100 mb-2">
            Resetear Contrase√±a
          </h1>
          <p className="text-slate-400">
            Ingresa tu email y te enviaremos instrucciones para resetear tu contrase√±a
          </p>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-slate-300 mb-2">
              Email
            </label>
            <input
              {...register('email')}
              type="email"
              autoComplete="email"
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="tu@email.com"
            />
            {errors.email && (
              <p className="mt-1 text-sm text-red-400">{errors.email.message}</p>
            )}
          </div>

          <button
            type="submit"
            disabled={isSubmitting}
            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isSubmitting ? 'Enviando...' : 'Enviar Instrucciones'}
          </button>
        </form>

        <div className="mt-6 text-center">
          <Link
            to="/sign-in"
            className="text-blue-400 hover:text-blue-300 text-sm"
          >
            Volver a Sign In
          </Link>
        </div>
      </div>
    </div>
  )
}
```

---

## Generaci√≥n y Manejo de Tokens

### L√≥gica del Servidor

```typescript
// src/server/services/passwordResetService.ts

import crypto from 'crypto'
import { db } from '@/lib/database'
import { emailService } from '@/lib/emailService'

export class PasswordResetService {
  /**
   * Generar token seguro de reset
   */
  static generateResetToken(): string {
    // Token criptogr√°ficamente seguro de 32 bytes
    return crypto.randomBytes(32).toString('hex')
  }

  /**
   * Crear solicitud de reset
   */
  static async createResetRequest(email: string): Promise<void> {
    // Verificar si el usuario existe
    const user = await db.user.findUnique({
      where: { email },
    })

    if (!user) {
      // No revelar si el email existe o no
      return
    }

    // Verificar rate limiting
    await this.checkRateLimit(user.id)

    // Generar token
    const token = this.generateResetToken()
    const expiresAt = new Date(Date.now() + 30 * 60 * 1000) // 30 minutos

    // Guardar token en base de datos
    await db.passwordResetToken.create({
      data: {
        token,
        userId: user.id,
        expiresAt,
      },
    })

    // Enviar email
    await this.sendResetEmail(user.email, token)
  }

  /**
   * Verificar token de reset
   */
  static async verifyResetToken(token: string): Promise<{ userId: string } | null> {
    const resetToken = await db.passwordResetToken.findUnique({
      where: { token },
      include: { user: true },
    })

    if (!resetToken) {
      return null
    }

    // Verificar si no ha expirado
    if (resetToken.expiresAt < new Date()) {
      await db.passwordResetToken.delete({
        where: { id: resetToken.id },
      })
      return null
    }

    return { userId: resetToken.userId }
  }

  /**
   * Resetear contrase√±a
   */
  static async resetPassword(token: string, newPassword: string): Promise<void> {
    const verification = await this.verifyResetToken(token)
    
    if (!verification) {
      throw new Error('Token inv√°lido o expirado')
    }

    // Hash de nueva contrase√±a
    const hashedPassword = await bcrypt.hash(newPassword, 12)

    // Actualizar contrase√±a
    await db.user.update({
      where: { id: verification.userId },
      data: { password: hashedPassword },
    })

    // Invalidar todos los tokens de reset
    await db.passwordResetToken.deleteMany({
      where: { userId: verification.userId },
    })

    // Invalidar todos los tokens de autenticaci√≥n
    await db.authToken.deleteMany({
      where: { userId: verification.userId },
    })

    // Enviar notificaci√≥n de cambio
    await this.sendPasswordChangedNotification(verification.userId)
  }

  /**
   * Verificar rate limiting
   */
  private static async checkRateLimit(userId: string): Promise<void> {
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000)
    
    const recentRequests = await db.passwordResetToken.count({
      where: {
        userId,
        createdAt: { gte: oneHourAgo },
      },
    })

    if (recentRequests >= 5) {
      throw new Error('Demasiadas solicitudes de reset. Intenta m√°s tarde.')
    }
  }

  /**
   * Enviar email de reset
   */
  private static async sendResetEmail(email: string, token: string): Promise<void> {
    const resetUrl = `${process.env.FRONTEND_URL}/password-reset/confirm?token=${token}`
    
    await emailService.sendEmail({
      to: email,
      subject: 'Resetear tu contrase√±a',
      template: 'password-reset',
      data: {
        resetUrl,
        expirationHours: 0.5, // 30 minutos
      },
    })
  }

  /**
   * Enviar notificaci√≥n de cambio de contrase√±a
   */
  private static async sendPasswordChangedNotification(userId: string): Promise<void> {
    const user = await db.user.findUnique({
      where: { id: userId },
    })

    if (!user) return

    await emailService.sendEmail({
      to: user.email,
      subject: 'Tu contrase√±a ha sido cambiada',
      template: 'password-changed',
      data: {
        loginUrl: `${process.env.FRONTEND_URL}/sign-in`,
      },
    })
  }
}
```

---

## Formulario de Reset de Contrase√±a

### Componente de Confirmaci√≥n

```tsx
// src/pages/PasswordResetConfirmPage.tsx

import { useState, useEffect } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { useSearchParams, useNavigate } from 'react-router-dom'
import { apiClient } from '@/lib/api-client'

const passwordResetSchema = z.object({
  password: z.string()
    .min(8, 'La contrase√±a debe tener al menos 8 caracteres')
    .regex(/[A-Z]/, 'Debe contener al menos una may√∫scula')
    .regex(/[a-z]/, 'Debe contener al menos una min√∫scula')
    .regex(/[0-9]/, 'Debe contener al menos un n√∫mero'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'Las contrase√±as no coinciden',
  path: ['confirmPassword'],
})

type PasswordResetData = z.infer<typeof passwordResetSchema>

export function PasswordResetConfirmPage() {
  const [searchParams] = useSearchParams()
  const navigate = useNavigate()
  const [token, setToken] = useState<string | null>(null)
  const [isVerifying, setIsVerifying] = useState(true)
  const [tokenValid, setTokenValid] = useState(false)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [success, setSuccess] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<PasswordResetData>({
    resolver: zodResolver(passwordResetSchema),
  })

  useEffect(() => {
    const tokenParam = searchParams.get('token')
    if (!tokenParam) {
      navigate('/password-reset/request')
      return
    }

    setToken(tokenParam)
    verifyToken(tokenParam)
  }, [searchParams, navigate])

  const verifyToken = async (tokenToVerify: string) => {
    try {
      const response = await apiClient.post('/auth/password-reset/verify', {
        token: tokenToVerify,
      })
      
      setTokenValid(response.data.valid)
    } catch (error) {
      setTokenValid(false)
    } finally {
      setIsVerifying(false)
    }
  }

  const onSubmit = async (data: PasswordResetData) => {
    if (!token) return

    setIsSubmitting(true)
    
    try {
      await apiClient.post('/auth/password-reset/confirm', {
        token,
        password: data.password,
      })
      
      setSuccess(true)
      
      // Redirigir a sign-in despu√©s de 3 segundos
      setTimeout(() => {
        navigate('/sign-in')
      }, 3000)
    } catch (error) {
      console.error('Error al resetear contrase√±a:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (isVerifying) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-950">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4" />
          <p className="text-slate-400">Verificando enlace de reset...</p>
        </div>
      </div>
    )
  }

  if (!tokenValid) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-950">
        <div className="max-w-md w-full p-8 bg-slate-900 rounded-xl">
          <div className="text-center">
            <div className="w-16 h-16 bg-red-600 bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-slate-100 mb-2">
              Enlace Inv√°lido
            </h2>
            <p className="text-slate-400 mb-6">
              Este enlace de reset ha expirado o no es v√°lido.
            </p>
            <Link
              to="/password-reset/request"
              className="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Solicitar Nuevo Enlace
            </Link>
          </div>
        </div>
      </div>
    )
  }

  if (success) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-950">
        <div className="max-w-md w-full p-8 bg-slate-900 rounded-xl">
          <div className="text-center">
            <div className="w-16 h-16 bg-green-600 bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-slate-100 mb-2">
              Contrase√±a Reseteada
            </h2>
            <p className="text-slate-400 mb-6">
              Tu contrase√±a ha sido actualizada exitosamente.
            </p>
            <p className="text-sm text-slate-500">
              Ser√°s redirigido a sign-in...
            </p>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950">
      <div className="max-w-md w-full p-8 bg-slate-900 rounded-xl">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-slate-100 mb-2">
            Nueva Contrase√±a
          </h1>
          <p className="text-slate-400">
            Ingresa tu nueva contrase√±a
          </p>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-slate-300 mb-2">
              Nueva Contrase√±a
            </label>
            <input
              {...register('password')}
              type="password"
              autoComplete="new-password"
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
            {errors.password && (
              <p className="mt-1 text-sm text-red-400">{errors.password.message}</p>
            )}
          </div>

          <div>
            <label htmlFor="confirmPassword" className="block text-sm font-medium text-slate-300 mb-2">
              Confirmar Contrase√±a
            </label>
            <input
              {...register('confirmPassword')}
              type="password"
              autoComplete="new-password"
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
            {errors.confirmPassword && (
              <p className="mt-1 text-sm text-red-400">{errors.confirmPassword.message}</p>
            )}
          </div>

          <button
            type="submit"
            disabled={isSubmitting}
            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isSubmitting ? 'Reseteando...' : 'Resetear Contrase√±a'}
          </button>
        </form>
      </div>
    </div>
  )
}
```

---

## Plantillas de Email

### Template de Reset de Contrase√±a

```html
<!-- src/emails/password-reset.html -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resetear tu contrase√±a</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            width: 48px;
            height: 48px;
            background-color: #3b82f6;
            border-radius: 8px;
            margin: 0 auto 20px;
        }
        h1 {
            color: #1f2937;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .button {
            display: inline-block;
            background-color: #3b82f6;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            margin: 20px 0;
        }
        .button:hover {
            background-color: #2563eb;
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #6b7280;
            text-align: center;
        }
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"></div>
            <h1>Resetear tu contrase√±a</h1>
            <p>Recibimos una solicitud para resetear tu contrase√±a</p>
        </div>

        <p>Hola,</p>
        
        <p>Haz clic en el siguiente bot√≥n para resetear tu contrase√±a:</p>
        
        <div style="text-align: center;">
            <a href="{{resetUrl}}" class="button">Resetear Contrase√±a</a>
        </div>

        <div class="warning">
            <strong>Importante:</strong> Este enlace expirar√° en {{expirationHours}} horas por razones de seguridad.
        </div>

        <p>Si no solicitaste resetear tu contrase√±a, puedes ignorar este email de forma segura.</p>
        
        <p>Si tienes problemas con el bot√≥n, copia y pega este enlace en tu navegador:</p>
        <p style="word-break: break-all; color: #3b82f6;">{{resetUrl}}</p>

        <div class="footer">
            <p>Este es un email autom√°tico. Por favor no respondas a este mensaje.</p>
            <p>¬© 2024 Forum. Todos los derechos reservados.</p>
        </div>
    </div>
</body>
</html>
```

### Template de Notificaci√≥n de Cambio

```html
<!-- src/emails/password-changed.html -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu contrase√±a ha sido cambiada</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .icon {
            width: 48px;
            height: 48px;
            background-color: #10b981;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        h1 {
            color: #1f2937;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .alert {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 16px;
            margin: 20px 0;
        }
        .alert-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }
        .button {
            display: inline-block;
            background-color: #3b82f6;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            margin: 20px 0;
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #6b7280;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
            </div>
            <h1>Tu contrase√±a ha sido cambiada</h1>
            <p>Confirmaci√≥n de cambio de contrase√±a</p>
        </div>

        <p>Hola,</p>
        
        <p>Te confirmamos que tu contrase√±a ha sido cambiada exitosamente.</p>

        <div class="alert">
            <div class="alert-title">üîí Informaci√≥n de Seguridad</div>
            <p>Si no realizaste este cambio, por favor contacta a nuestro equipo de soporte inmediatamente y cambia tu contrase√±a.</p>
        </div>

        <div style="text-align: center;">
            <a href="{{loginUrl}}" class="button">Iniciar Sesi√≥n</a>
        </div>

        <p>Por tu seguridad, todas las sesiones activas han sido cerradas. Necesitar√°s iniciar sesi√≥n nuevamente.</p>

        <div class="footer">
            <p>Este es un email autom√°tico. Por favor no respondas a este mensaje.</p>
            <p>¬© 2024 Forum. Todos los derechos reservados.</p>
        </div>
    </div>
</body>
</html>
```

---

## API Endpoints

### Routes del Servidor

```typescript
// src/server/routes/passwordReset.ts

import express from 'express'
import { PasswordResetService } from '@/services/passwordResetService'
import { rateLimit } from 'express-rate-limit'

const router = express.Router()

// Rate limiting para prevenir abuso
const resetRateLimit = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hora
  max: 5, // M√°ximo 5 solicitudes por hora por IP
  message: 'Demasiadas solicitudes de reset. Intenta m√°s tarde.',
})

/**
 * POST /auth/password-reset/request
 * Solicitar reset de contrase√±a
 */
router.post('/request', resetRateLimit, async (req, res) => {
  try {
    const { email } = req.body
    
    if (!email) {
      return res.status(400).json({ error: 'Email es requerido' })
    }

    await PasswordResetService.createResetRequest(email)
    
    // Siempre retornar √©xito para no revelar si el email existe
    res.json({ message: 'Si el email existe, recibir√°s instrucciones' })
  } catch (error) {
    console.error('Error en solicitud de reset:', error)
    res.status(500).json({ error: 'Error interno del servidor' })
  }
})

/**
 * POST /auth/password-reset/verify
 * Verificar token de reset
 */
router.post('/verify', async (req, res) => {
  try {
    const { token } = req.body
    
    if (!token) {
      return res.status(400).json({ error: 'Token es requerido' })
    }

    const verification = await PasswordResetService.verifyResetToken(token)
    
    res.json({ 
      valid: !!verification,
      userId: verification?.userId || null,
    })
  } catch (error) {
    console.error('Error en verificaci√≥n de token:', error)
    res.status(500).json({ error: 'Error interno del servidor' })
  }
})

/**
 * POST /auth/password-reset/confirm
 * Confirmar reset de contrase√±a
 */
router.post('/confirm', async (req, res) => {
  try {
    const { token, password } = req.body
    
    if (!token || !password) {
      return res.status(400).json({ error: 'Token y contrase√±a son requeridos' })
    }

    // Validar fortaleza de contrase√±a
    if (password.length < 8) {
      return res.status(400).json({ error: 'La contrase√±a debe tener al menos 8 caracteres' })
    }

    await PasswordResetService.resetPassword(token, password)
    
    res.json({ message: 'Contrase√±a reseteada exitosamente' })
  } catch (error) {
    console.error('Error en confirmaci√≥n de reset:', error)
    
    if (error.message === 'Token inv√°lido o expirado') {
      return res.status(400).json({ error: error.message })
    }
    
    res.status(500).json({ error: 'Error interno del servidor' })
  }
})

export default router
```

---

## Mejores Pr√°cticas de Seguridad

### ‚úÖ Implementaciones Seguras

```typescript
// src/server/middleware/security.ts

import rateLimit from 'express-rate-limit'
import helmet from 'helmet'
import { Request, Response, NextFunction } from 'express'

/**
 * Rate limiting espec√≠fico para endpoints sensibles
 */
export const sensitiveRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 3, // M√°ximo 3 intentos
  message: 'Demasiados intentos. Intenta m√°s tarde.',
  standardHeaders: true,
  legacyHeaders: false,
})

/**
 * Validaci√≥n de token seguro
 */
export const validateResetToken = async (req: Request, res: Response, next: NextFunction) => {
  const { token } = req.body
  
  if (!token || typeof token !== 'string' || token.length !== 64) {
    return res.status(400).json({ error: 'Token inv√°lido' })
  }
  
  // Verificar formato hexadecimal
  if (!/^[a-f0-9]{64}$/i.test(token)) {
    return res.status(400).json({ error: 'Token inv√°lido' })
  }
  
  next()
}

/**
 * Logging de intentos de reset
 */
export const logResetAttempt = (req: Request, res: Response, next: NextFunction) => {
  console.log('Password reset attempt:', {
    ip: req.ip,
    userAgent: req.get('User-Agent'),
    timestamp: new Date().toISOString(),
    email: req.body.email,
  })
  
  next()
}
```

### ‚ùå Vulnerabilidades Comunes y Soluciones

```typescript
// ‚ùå VULNERABLE: Tokens predecibles
function generateBadToken() {
  return Math.random().toString(36) // Predecible
}

// ‚úÖ SECURE: Tokens criptogr√°ficamente seguros
function generateSecureToken() {
  return crypto.randomBytes(32).toString('hex') // Criptogr√°ficamente seguro
}

// ‚ùå VULNERABLE: No rate limiting
app.post('/reset', (req, res) => {
  // Permite ataques de fuerza bruta
})

// ‚úÖ SECURE: Con rate limiting
app.post('/reset', rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 5,
}), (req, res) => {
  // Protegido contra ataques de fuerza bruta
})

// ‚ùå VULNERABLE: Revela si el email existe
if (!user) {
  return res.status(404).json({ error: 'Email no encontrado' })
}

// ‚úÖ SECURE: No revela informaci√≥n
if (!user) {
  return res.json({ message: 'Si el email existe, recibir√°s instrucciones' })
}
```

---

## Testing del Flujo de Reset

### Pruebas Unitarias

```typescript
// src/server/services/__tests__/passwordResetService.test.ts

import { PasswordResetService } from '../passwordResetService'
import { db } from '@/lib/database'
import { emailService } from '@/lib/emailService'

vi.mock('@/lib/database')
vi.mock('@/lib/emailService')

describe('PasswordResetService', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('createResetRequest', () => {
    it('debe crear solicitud de reset para usuario existente', async () => {
      const mockUser = { id: '1', email: 'test@example.com' }
      vi.mocked(db.user.findUnique).mockResolvedValue(mockUser)
      vi.mocked(db.passwordResetToken.create).mockResolvedValue({})
      vi.mocked(emailService.sendEmail).mockResolvedValue({})

      await PasswordResetService.createResetRequest('test@example.com')

      expect(db.user.findUnique).toHaveBeenCalledWith({
        where: { email: 'test@example.com' },
      })
      expect(db.passwordResetToken.create).toHaveBeenCalled()
      expect(emailService.sendEmail).toHaveBeenCalled()
    })

    it('no debe revelar si el email no existe', async () => {
      vi.mocked(db.user.findUnique).mockResolvedValue(null)

      // No debe lanzar error
      await expect(
        PasswordResetService.createResetRequest('nonexistent@example.com')
      ).resolves.not.toThrow()

      expect(db.passwordResetToken.create).not.toHaveBeenCalled()
      expect(emailService.sendEmail).not.toHaveBeenCalled()
    })

    it('debe respetar rate limiting', async () => {
      const mockUser = { id: '1', email: 'test@example.com' }
      vi.mocked(db.user.findUnique).mockResolvedValue(mockUser)
      vi.mocked(db.passwordResetToken.count).mockResolvedValue(5) // L√≠mite alcanzado

      await expect(
        PasswordResetService.createResetRequest('test@example.com')
      ).rejects.toThrow('Demasiadas solicitudes de reset')
    })
  })

  describe('verifyResetToken', () => {
    it('debe verificar token v√°lido', async () => {
      const mockToken = {
        token: 'valid-token',
        userId: '1',
        expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30 minutos en el futuro
      }
      vi.mocked(db.passwordResetToken.findUnique).mockResolvedValue(mockToken)

      const result = await PasswordResetService.verifyResetToken('valid-token')

      expect(result).toEqual({ userId: '1' })
    })

    it('debe rechazar token expirado', async () => {
      const mockToken = {
        token: 'expired-token',
        userId: '1',
        expiresAt: new Date(Date.now() - 30 * 60 * 1000), // 30 minutos en el pasado
      }
      vi.mocked(db.passwordResetToken.findUnique).mockResolvedValue(mockToken)
      vi.mocked(db.passwordResetToken.delete).mockResolvedValue({})

      const result = await PasswordResetService.verifyResetToken('expired-token')

      expect(result).toBeNull()
      expect(db.passwordResetToken.delete).toHaveBeenCalled()
    })
  })
})
```

---

## Resumen

### Conceptos Clave

1. **Flujo Seguro**: Solicitud ‚Üí Verificaci√≥n ‚Üí Reset ‚Üí Notificaci√≥n
2. **Tokens Seguros**: Criptogr√°ficamente aleatorios, temporales, √∫nicos
3. **Rate Limiting**: Prevenir ataques de fuerza bruta
4. **Validaci√≥n**: Verificaci√≥n del lado del servidor
5. **Email Templates**: Comunicaci√≥n clara y profesional
6. **Logging**: Auditor√≠a de intentos de reset

### Checklist de Seguridad

- ‚úÖ Tokens criptogr√°ficamente seguros
- ‚úÖ Expiraci√≥n de tokens (15-30 minutos)
- ‚úÖ Rate limiting por IP y usuario
- ‚úÖ Verificaci√≥n del lado del servidor
- ‚úÖ Invalidaci√≥n de tokens despu√©s del uso
- ‚úÖ Notificaciones de cambios de contrase√±a
- ‚úÖ Logging de intentos
- ‚úÖ No revelar si el email existe
- ‚úÖ HTTPS obligatorio
- ‚úÖ Validaci√≥n de fortaleza de contrase√±a

### Mejores Pr√°cticas

- ‚úÖ Siempre verificar tokens en el servidor
- ‚úÖ Usar tokens √∫nicos por solicitud
- ‚úÖ Implementar rate limiting agresivo
- ‚úÖ Enviar notificaciones de cambios
- ‚úÖ Invalidar todas las sesiones despu√©s del reset
- ‚úÖ Usar HTTPS para todo el flujo
- ‚úÖ Probar exhaustivamente todos los escenarios

---

Siguiente: [Auth Context ‚Üí](/es/react/7.auth-module/2.auth-context)
