---
title: Create Reply - Context-Aware Forms & Inline Composition
description: Master inline forms, parent context passing, markdown composition, optimistic UI updates, and nested interaction patterns. Build a production-ready reply system.
---

# Disclaimer

:::u-alert
---
title: Comments in the code are for educational purposes only.
description: In real projects, avoid adding irrelevant or redundant comments.
color: warning
variant: subtle
icon: i-lucide-triangle-alert
---
:::

Creating replies is fundamentally different from creating threads. Replies are **contextual** - they must know their parent, appear inline, and integrate seamlessly into the conversation tree. This introduces new patterns: inline forms, context propagation, and nested UI state management.

---

## What We're Building

A sophisticated reply system with:
- **Inline composition**: Form appears below parent post
- **Context awareness**: Knows parent post and thread
- **Markdown support**: Full editor with preview
- **User mentions**: @username autocompletion
- **Draft saving**: Auto-save to localStorage
- **Optimistic updates**: Reply appears instantly
- **Nested threading**: Support unlimited reply depth
- **Keyboard shortcuts**: Cmd+Enter to submit
- **Cancel behavior**: Discard draft with confirmation

**Visual Flow:**
```
Post by @alice: "How do I learn React?"
  [Reply button]

User clicks Reply â†’

Post by @alice: "How do I learn React?"
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ [Markdown Editor]                   â”‚
  â”‚ Write your reply...                 â”‚
  â”‚                                     â”‚
  â”‚ [Preview] [Cancel] [Post Reply]     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User types and submits â†’

Post by @alice: "How do I learn React?"
  â””â”€ Post by @bob: "Start with the docs!" (NEW)
     [Reply button]
```

---

## The Challenge: Inline Forms vs Modal Forms

### Two Approaches to Reply Forms

**Approach 1: Modal Form** âŒ
```tsx
<button onClick={() => setShowModal(true)}>Reply</button>
<Modal isOpen={showModal}>
  <ReplyForm />
</Modal>
```

**Problems:**
- Loses context (can't see parent post)
- Disruptive (covers entire screen)
- Hard to reference parent content
- Poor UX for quick replies

**Approach 2: Inline Form** âœ…
```tsx
<Post>
  <button onClick={() => setShowForm(true)}>Reply</button>
  {showForm && <ReplyForm />}
</Post>
```

**Benefits:**
- Context preserved (parent visible)
- Non-disruptive (stays in flow)
- Easy to reference parent
- Better UX for conversations

---

## State Management: Who Owns the Form?

### The Problem: Nested State

Each post can have a reply form. Where does form state live?

**Option 1: Parent Component** âŒ
```tsx
function ThreadPage() {
  const [replyingTo, setReplyingTo] = useState<string | null>(null)
  
  return posts.map(post => (
    <Post
      post={post}
      isReplying={replyingTo === post.id}
      onReply={() => setReplyingTo(post.id)}
    />
  ))
}
```

**Problems:**
- Parent re-renders on every reply action
- Hard to manage multiple open forms
- Prop drilling (pass callbacks down)

**Option 2: Component-Level State** âœ…
```tsx
function Post({ post }: { post: Post }) {
  const [showReplyForm, setShowReplyForm] = useState(false)
  
  return (
    <div>
      <PostContent />
      <button onClick={() => setShowReplyForm(true)}>Reply</button>
      {showReplyForm && <ReplyForm />}
    </div>
  )
}
```

**Benefits:**
- Isolated state (no parent re-renders)
- Multiple forms can be open
- No prop drilling
- Simpler mental model

---

## Understanding Context: threadId + parentId

Every reply needs TWO pieces of context:

1. **threadId**: Which thread is this reply in?
2. **parentId**: Which post is this replying to?

```typescript
interface ReplyContext {
  threadId: string  // "01HXQK9Z3XAMPLE000001"
  parentId: string  // "01HXQK9Z3XAMPLE000002"
}
```

**Why both?**
- `threadId`: For API endpoint (`POST /threads/:threadId/posts`)
- `parentId`: For building nested structure
- Backend needs both to validate and organize

**Example:**
```
Thread: "How to learn React?"  (threadId: abc123)
â”œâ”€ Post #1 by @alice            (id: post1, parentId: null)
â”‚  â””â”€ Reply by @bob              (id: post2, parentId: post1, threadId: abc123)
â”‚     â””â”€ Reply by @alice         (id: post3, parentId: post2, threadId: abc123)
â””â”€ Post #2 by @charlie          (id: post4, parentId: null)
```

---

## Reply Composer Component

```tsx
// src/components/posts/ReplyComposer.tsx

import { useState, useRef, useEffect } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { MarkdownEditor } from '@/components/ui/MarkdownEditor'
import { apiClient } from '@/lib/api-client'
import { toast } from '@/lib/toast'
import type { Post } from '@/types'

/**
 * Reply validation schema
 * 
 * Rules:
 * - Minimum 10 characters (prevent spam)
 * - Maximum 10,000 characters (prevent abuse)
 * - Trim whitespace
 */
const replySchema = z.object({
  content: z
    .string()
    .trim()
    .min(10, 'Reply must be at least 10 characters')
    .max(10000, 'Reply must be less than 10,000 characters'),
})

type ReplyInput = z.infer<typeof replySchema>

interface ReplyComposerProps {
  threadId: string
  parentId: string
  parentAuthor: string  // For context display
  onSuccess: (post: Post) => void
  onCancel: () => void
}

/**
 * ReplyComposer - Inline form for creating replies
 * 
 * Features:
 * - Markdown editor with preview
 * - Auto-save drafts to localStorage
 * - Keyboard shortcuts (Cmd+Enter to submit)
 * - Optimistic UI updates
 * - Context display (replying to...)
 * 
 * State management:
 * - Form state: React Hook Form
 * - Draft: localStorage (key: `draft-reply-${parentId}`)
 * - Preview toggle: local state
 */
export function ReplyComposer({
  threadId,
  parentId,
  parentAuthor,
  onSuccess,
  onCancel,
}: ReplyComposerProps) {
  const [showPreview, setShowPreview] = useState(false)
  const editorRef = useRef<HTMLTextAreaElement>(null)

  /**
   * Form setup with React Hook Form + Zod
   */
  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<ReplyInput>({
    resolver: zodResolver(replySchema),
    defaultValues: {
      // Load draft from localStorage
      content: loadDraft(parentId),
    },
  })

  const content = watch('content')

  /**
   * Auto-save draft to localStorage
   * 
   * Debounced to avoid excessive writes
   */
  useEffect(() => {
    const timer = setTimeout(() => {
      if (content) {
        saveDraft(parentId, content)
      }
    }, 1000)  // Debounce 1 second

    return () => clearTimeout(timer)
  }, [content, parentId])

  /**
   * Focus editor on mount
   * 
   * Better UX: user can start typing immediately
   */
  useEffect(() => {
    editorRef.current?.focus()
  }, [])

  /**
   * Keyboard shortcuts
   * 
   * Cmd+Enter (Mac) / Ctrl+Enter (Windows): Submit
   * Escape: Cancel
   */
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Cmd+Enter or Ctrl+Enter: Submit
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault()
        handleSubmit(onSubmit)()
      }

      // Escape: Cancel
      if (e.key === 'Escape') {
        e.preventDefault()
        handleCancel()
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [])

  /**
   * Submit handler
   * 
   * 1. Validate with Zod
   * 2. Send to API
   * 3. Clear draft
   * 4. Call onSuccess with new post
   * 5. Show toast notification
   */
  const onSubmit = async (data: ReplyInput) => {
    try {
      const response = await apiClient.post<Post>('/posts', {
        threadId,
        parentId,
        content: data.content,
      })

      // Clear draft
      clearDraft(parentId)

      // Show success
      toast.success('Reply posted!')

      // Notify parent (will add to UI optimistically)
      onSuccess(response.data)
    } catch (error) {
      // Handle errors
      const message =
        error instanceof Error
          ? error.message
          : 'Failed to post reply'
      toast.error(message)
    }
  }

  /**
   * Cancel handler
   * 
   * If draft exists, confirm before discarding
   */
  const handleCancel = () => {
    if (content && content.length > 10) {
      if (
        !window.confirm(
          'You have unsaved changes. Discard draft?'
        )
      ) {
        return
      }
    }

    // Clear draft
    clearDraft(parentId)

    // Notify parent to hide form
    onCancel()
  }

  return (
    <div className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-800">
      {/* Context Header */}
      <div className="mb-3 text-sm text-slate-400">
        Replying to{' '}
        <span className="text-blue-400 font-medium">
          @{parentAuthor}
        </span>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {/* Markdown Editor */}
        <div>
          <MarkdownEditor
            ref={editorRef}
            value={content}
            onChange={(value) => setValue('content', value)}
            placeholder="Write your reply... (Markdown supported)"
            showPreview={showPreview}
            minHeight={120}
          />

          {/* Validation Error */}
          {errors.content && (
            <p className="mt-2 text-sm text-red-400">
              {errors.content.message}
            </p>
          )}

          {/* Character Count */}
          <div className="mt-2 text-xs text-slate-500">
            {content.length} / 10,000 characters
          </div>
        </div>

        {/* Actions */}
        <div className="flex items-center justify-between">
          {/* Left: Preview Toggle */}
          <button
            type="button"
            onClick={() => setShowPreview(!showPreview)}
            className="text-sm text-slate-400 hover:text-slate-200"
          >
            {showPreview ? 'âœï¸ Edit' : 'ğŸ‘ï¸ Preview'}
          </button>

          {/* Right: Cancel + Submit */}
          <div className="flex items-center gap-3">
            <button
              type="button"
              onClick={handleCancel}
              className="px-4 py-2 bg-slate-800 text-slate-200 rounded-lg hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>

            <button
              type="submit"
              disabled={isSubmitting || !content.trim()}
              className={`
                px-4 py-2 rounded-lg font-medium transition-colors
                ${
                  isSubmitting || !content.trim()
                    ? 'bg-blue-600/50 text-white cursor-not-allowed'
                    : 'bg-blue-600 text-white hover:bg-blue-700'
                }
              `}
            >
              {isSubmitting ? 'Posting...' : 'Post Reply'}
            </button>
          </div>
        </div>

        {/* Keyboard Hint */}
        <p className="text-xs text-slate-500">
          <kbd className="px-2 py-1 bg-slate-800 rounded text-xs">
            {navigator.platform.includes('Mac') ? 'âŒ˜' : 'Ctrl'}+Enter
          </kbd>{' '}
          to post,{' '}
          <kbd className="px-2 py-1 bg-slate-800 rounded text-xs">
            Esc
          </kbd>{' '}
          to cancel
        </p>
      </form>
    </div>
  )
}

/**
 * Draft Management Utilities
 * 
 * Store drafts in localStorage with unique keys per parent post
 */

function getDraftKey(parentId: string): string {
  return `draft-reply-${parentId}`
}

function loadDraft(parentId: string): string {
  try {
    return localStorage.getItem(getDraftKey(parentId)) || ''
  } catch {
    return ''
  }
}

function saveDraft(parentId: string, content: string): void {
  try {
    localStorage.setItem(getDraftKey(parentId), content)
  } catch (error) {
    console.error('Failed to save draft:', error)
  }
}

function clearDraft(parentId: string): void {
  try {
    localStorage.removeItem(getDraftKey(parentId))
  } catch (error) {
    console.error('Failed to clear draft:', error)
  }
}
```

---

## Summary

### Key Patterns Learned

1. **Inline Forms**: Show forms contextually, not in modals
2. **Component-Level State**: Isolate state to prevent parent re-renders
3. **Context Propagation**: Pass threadId + parentId
4. **Draft Management**: Auto-save with localStorage
5. **Keyboard Shortcuts**: Cmd+Enter, Escape
6. **Optimistic Updates**: Add to UI before API confirms
7. **Confirmation Dialogs**: Warn before discarding drafts

### Best Practices

- âœ… Auto-focus editor on mount
- âœ… Auto-save drafts with debouncing
- âœ… Show context ("Replying to @user")
- âœ… Keyboard shortcuts for power users
- âœ… Character count for guidance
- âœ… Disable submit when empty
- âœ… Confirm before discarding drafts
- âœ… Clear error messages

---

Next: [Vote System â†’](/en/react/6.posts-module/3.vote-system)

---

## Reply Component with Context

```tsx
// src/components/posts/ReplyComposer.tsx

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { MarkdownEditor } from '@/components/ui/MarkdownEditor'
import { apiClient } from '@/lib/api-client'
import { toast } from '@/lib/toast'
import type { Post } from '@/types'

const replySchema = z.object({
  content: z.string().min(10, 'Reply must be at least 10 characters'),
})

type ReplyInput = z.infer<typeof replySchema>

interface ReplyComposerProps {
  threadId: string
  parentId: string  // ID of post being replied to
  onSuccess: (post: Post) => void
  onCancel: () => void
}

export function ReplyComposer({
  threadId,
  parentId,
  onSuccess,
  onCancel,
}: ReplyComposerProps) {
  const [showPreview, setShowPreview] = useState(false)

  const {
    register,
    handleSubmit,
    watch,
    formState: { errors, isSubmitting },
  } = useForm<ReplyInput>({
    resolver: zodResolver(replySchema),
    defaultValues: { content: '' },
  })

  const content = watch('content')

  const onSubmit = async (data: ReplyInput) => {
    try {
      const response = await apiClient.post<Post>('/posts', {
        threadId,
        parentId,
        content: data.content,
      })

      toast.success('Reply posted!')
      onSuccess(response.data)
    } catch (error) {
      toast.error('Failed to post reply')
    }
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-800">
      <MarkdownEditor
        value={content}
        onChange={(value) => register('content').onChange({ target: { value } })}
        placeholder="Write your reply..."
        showPreview={showPreview}
      />

      {errors.content && (
        <p className="mt-2 text-sm text-red-400">{errors.content.message}</p>
      )}

      <div className="flex items-center gap-3 mt-4">
        <button
          type="submit"
          disabled={isSubmitting}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          {isSubmitting ? 'Posting...' : 'Post Reply'}
        </button>

        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 bg-slate-800 text-slate-200 rounded-lg hover:bg-slate-700"
        >
          Cancel
        </button>

        <button
          type="button"
          onClick={() => setShowPreview(!showPreview)}
          className="ml-auto text-sm text-slate-400 hover:text-slate-200"
        >
          {showPreview ? 'Edit' : 'Preview'}
        </button>
      </div>
    </form>
  )
}
```

---

## Integrating Reply Composer

```tsx
// src/components/posts/PostCard.tsx

import { useState } from 'react'
import { ReplyComposer } from './ReplyComposer'

export function PostCard({ post, allPosts, threadId }: PostCardProps) {
  const [showReplyForm, setShowReplyForm] = useState(false)
  const [localPosts, setLocalPosts] = useState(allPosts)

  const handleReplySuccess = (newPost: Post) => {
    setLocalPosts([...localPosts, newPost])
    setShowReplyForm(false)
  }

  return (
    <div className="border-l-2 border-slate-800 pl-4 py-3">
      {/* Post content */}
      <div>
        {/* ... post header, content, actions ... */}
        
        <button
          onClick={() => setShowReplyForm(!showReplyForm)}
          className="text-sm text-slate-400 hover:text-slate-200"
        >
          {showReplyForm ? 'Cancel' : 'Reply'}
        </button>
      </div>

      {/* Reply form */}
      {showReplyForm && (
        <ReplyComposer
          threadId={threadId}
          parentId={post.id}
          onSuccess={handleReplySuccess}
          onCancel={() => setShowReplyForm(false)}
        />
      )}

      {/* Nested replies (recursive) */}
      {/* ... */}
    </div>
  )
}
```

---

## Summary

### Key Patterns

1. **Inline Forms**: Show/hide forms contextually
2. **Parent Context**: Pass threadId + parentId
3. **Optimistic Updates**: Add to local state immediately
4. **Cancel Action**: Allow users to bail out

---

Next: [Vote System â†’](/en/react/6.posts-module/3.vote-system)
